<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark PDF Converter</title>

    <!-- pdf-lib -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- PDF.js per estrarre testo dai PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <!-- Mammoth per leggere DOCX -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.5.0/mammoth.browser.min.js"></script>

    <style>
        body {
            background: #111;
            color: #eee;
            font-family: Verdana, sans-serif;
            padding: 20px;
        }
        h1 {
            margin-top: 0;
        }
        .panel {
            background: #1b1b1b;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .panel label {
            display: block;
            margin-top: 10px;
            margin-bottom: 4px;
            font-size: 14px;
        }
        .panel input[type="number"],
        .panel input[type="text"],
        .panel input[type="file"] {
            width: 100%;
            max-width: 300px;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #111;
            color: #eee;
            font-family: Verdana, sans-serif;
            font-size: 14px;
        }
        .btn {
            padding: 12px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-family: Verdana, sans-serif;
            font-size: 14px;
        }
        .btn-primary {
            background: #3d8db7;
            color: white;
        }
        .btn-primary:hover:enabled {
            background: #2a6a8e;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #preview {
            white-space: pre-wrap;
            background: #000;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            min-height: 150px;
            line-height: 1.5;
            font-size: 14px;
            overflow-y: auto;
            max-height: 300px;
        }
        #status {
            margin-top: 10px;
            font-size: 13px;
            color: #aaa;
        }
        #fileInfo {
            font-size: 13px;
            margin-top: 8px;
            color: #ccc;
        }
    </style>
</head>

<body>
    <h1>Dark PDF Converter</h1>
    <p>Trasforma TXT, PDF, DOCX in un PDF con sfondo nero e testo bianco, con font Verdana, dimensione e interlinea configurabili.</p>

    <!-- Upload -->
    <div class="panel">
        <label for="fileInput">File (TXT, PDF, DOCX):</label>
        <input type="file" id="fileInput" accept=".txt,.pdf,.docx">
        <p id="fileInfo"></p>
    </div>

    <!-- Impostazioni -->
    <div class="panel">
        <label for="fontSize">Font size (px):</label>
        <input type="number" id="fontSize" value="14" min="12" max="30">

        <label for="lineHeight">Interlinea:</label>
        <input type="number" id="lineHeight" value="1.5" min="1" max="3" step="0.1">

        <label for="title">Titolo documento (opzionale):</label>
        <input type="text" id="title" placeholder="Titolo">
    </div>

    <!-- Anteprima -->
    <div class="panel">
        <h3>Anteprima (prime ~2000 caratteri)</h3>
        <div id="preview">Carica un file per vedere il contenuto…</div>
    </div>

    <!-- Esporta -->
    <div class="panel">
        <button class="btn btn-primary" id="exportPdf" disabled>Esporta PDF Dark</button>
        <p id="status"></p>
    </div>

<script>
let uploadedText = "";

// ---------------------
// CARICAMENTO FILE
// ---------------------
document.getElementById("fileInput").addEventListener("change", async e => {
    const file = e.target.files[0];
    if (!file) return;

    const status = document.getElementById("status");
    status.textContent = "Lettura file…";

    try {
        if (file.type === "text/plain") {
            uploadedText = await file.text();
        } else if (file.type === "application/pdf") {
            uploadedText = await extractTextFromPdf(file);
        } else if (file.type ===
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
            uploadedText = await extractTextFromDocx(file);
        } else {
            alert("Tipo file non supportato");
            status.textContent = "Tipo file non supportato.";
            return;
        }

        document.getElementById("fileInfo").textContent = "Caricato: " + file.name;
        document.getElementById("preview").textContent = uploadedText.substring(0, 2000);
        document.getElementById("exportPdf").disabled = false;
        status.textContent = "File pronto.";
    } catch (err) {
        console.error(err);
        status.textContent = "Errore nella lettura del file.";
        alert("Errore lettura file: " + err);
    }
});

// Estrazione testo PDF
async function extractTextFromPdf(file) {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
    let text = "";

    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(it => it.str).join(" ") + "\n\n";
    }
    return text;
}

// Estrazione DOCX
async function extractTextFromDocx(file) {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    return result.value;
}

// ---------------------
// ESPORTAZIONE PDF
// ---------------------
document.getElementById("exportPdf").addEventListener("click", exportPdf);

async function exportPdf() {
    const status = document.getElementById("status");

    if (!uploadedText.trim()) {
        alert("Nessun testo da esportare.");
        return;
    }

    try {
        status.textContent = "Generazione PDF…";

        const { PDFDocument, rgb } = PDFLib;
        const pdfDoc = await PDFDocument.create();

        // Carica Verdana dallo stesso repo (index.html e verdana.ttf nella stessa cartella)
        const fontBytes = await fetch("verdana.ttf").then(r => r.arrayBuffer());
        const font = await pdfDoc.embedFont(fontBytes);

        const fontSize = parseInt(document.getElementById("fontSize").value);
        const lineHeight = parseFloat(document.getElementById("lineHeight").value);
        const title = document.getElementById("title").value || "Documento";

        // Pagina A4 approssimata in punti
        let page = pdfDoc.addPage([595, 842]);
        const pageWidth = 595;
        const pageHeight = 842;
        const marginLeft = 50;
        const marginTop = 60;
        const marginBottom = 60;
        const maxWidth = pageWidth - marginLeft * 2;

        drawBackground(page);

        let y = pageHeight - marginTop;

        // Titolo
        if (title.trim()) {
            const titleSize = fontSize + 6;
            page.drawText(title, {
                x: marginLeft,
                y,
                size: titleSize,
                font,
                color: rgb(1, 1, 1)
            });
            y -= titleSize * lineHeight;
        }

        // Wrapping manuale del testo
        const paragraphs = uploadedText.split("\n");
        for (let para of paragraphs) {
            const words = para.split(" ");
            let line = "";

            for (let word of words) {
                const testLine = line ? line + " " + word : word;
                const textWidth = font.widthOfTextAtSize(testLine, fontSize);

                if (textWidth > maxWidth) {
                    // Stampa la linea corrente
                    if (y < marginBottom) {
                        page = pdfDoc.addPage([595, 842]);
                        drawBackground(page);
                        y = pageHeight - marginTop;
                    }
                    page.drawText(line, {
                        x: marginLeft,
                        y,
                        size: fontSize,
                        font,
                        color: rgb(1, 1, 1)
                    });
                    y -= fontSize * lineHeight;
                    line = word;
                } else {
                    line = testLine;
                }
            }

            // Ultima linea del paragrafo
            if (line) {
                if (y < marginBottom) {
                    page = pdfDoc.addPage([595, 842]);
                    drawBackground(page);
                    y = pageHeight - marginTop;
                }
                page.drawText(line, {
                    x: marginLeft,
                    y,
                    size: fontSize,
                    font,
                    color: rgb(1, 1, 1)
                });
                y -= fontSize * lineHeight;
            }

            // Riga vuota tra paragrafi
            y -= fontSize * (lineHeight - 1);
        }

        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });

        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = title + ".pdf";
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        status.textContent = "PDF creato con successo!";
    } catch (err) {
        console.error(err);
        status.textContent = "Errore nella generazione del PDF.";
        alert("Errore PDF: " + err);
    }
}

function drawBackground(page) {
    const { width, height } = page.getSize();
    const { rgb } = PDFLib;
    page.drawRectangle({
        x: 0,
        y: 0,
        width,
        height,
        color: rgb(0, 0, 0)
    });
}
</script>

</body>
</html>
