<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>PDF Nero per Ipovedenti</title>
</head>

<body style="background:#111; color:white; font-family:Arial; padding:40px">

<h2>Converti file in PDF ad alto contrasto (Verdana bianco su nero)</h2>

<input type="file" id="fileInput" accept=".txt,.pdf,.docx" />
<button id="btnPdf" disabled>Esporta PDF</button>

<p id="status"></p>

<script type="module">
import { PDFDocument, rgb } from "https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.esm.js";
import fontkit from "https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.0.0/dist/fontkit.esm.js";

// ------------------------------------
// Utility
// ------------------------------------
function setStatus(msg){
    document.getElementById("status").textContent = msg;
}

let uploadedText = "";

// ------------------------------------
// Lettura file
// ------------------------------------
document.getElementById("fileInput").addEventListener("change", async (e)=>{
    const file = e.target.files[0];
    if(!file) return;

    setStatus("Caricamento...");

    if(file.type === "text/plain"){
        uploadedText = await file.text();
    } else {
        setStatus("Per ora supportato solo TXT, aggiungo PDF/DOCX dopo.");
        return;
    }

    setStatus("Caricamento avvenuto con successo.");
    document.getElementById("btnPdf").disabled = false;
});

// ------------------------------------
// Esporta PDF
// ------------------------------------
document.getElementById("btnPdf").addEventListener("click", async ()=>{

    try{
        if(!uploadedText){
            setStatus("Nessun testo caricato.");
            return;
        }

        setStatus("Generazione PDF...");

        const pdfDoc = await PDFDocument.create();

        // ðŸ”¥ 1. Registra fontkit
        pdfDoc.registerFontkit(fontkit);

        // ðŸ”¥ 2. Carica font Verdana locale
        const fontBytes = await fetch("verdana.ttf").then(r=>r.arrayBuffer());
        const verdana = await pdfDoc.embedFont(fontBytes);

        const page = pdfDoc.addPage([595, 842]);
        const fontSize = 14;
        const lineHeight = fontSize * 1.5;
        let y = 800;

        // Sfondo nero pieno
        page.drawRectangle({
            x:0, y:0, width:595, height:842,
            color: rgb(0,0,0)
        });

        // Testo bianco Verdana
        const lines = uploadedText.split("\n");

        for(const line of lines){
            if(y < 40){
                const p = pdfDoc.addPage([595,842]);
                p.drawRectangle({x:0,y:0,width:595,height:842,color:rgb(0,0,0)});
                y = 800;
            }

            page.drawText(line || " ", {
                x: 40,
                y: y,
                size: fontSize,
                font: verdana,
                color: rgb(1,1,1)
            });

            y -= lineHeight;
        }

        const pdfBytes = await pdfDoc.save();

        // Download
        const blob = new Blob([pdfBytes], {type:"application/pdf"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "testo_nero.pdf";
        a.click();
        URL.revokeObjectURL(url);

        setStatus("PDF esportato con successo.");

    } catch(err){
        setStatus("Errore PDF: " + err);
    }
});
</script>

</body>
</html>
