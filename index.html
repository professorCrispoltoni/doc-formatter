<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark PDF Converter</title>

    <!-- pdf-lib (solo core, senza fontkit) -->
    <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <!-- PDF.js per estrarre testo dai PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- Mammoth per leggere DOCX -->
    <script src="https://cdn.jsdelivr.net/npm/mammoth@1.5.0/mammoth.browser.min.js"></script>

    <style>
        body {
            background: #111;
            color: #eee;
            font-family: Verdana, sans-serif;
            padding: 20px;
        }
        h1 { margin-top: 0; }
        .panel {
            background: #1b1b1b;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .panel label {
            display: block;
            margin-top: 10px;
            margin-bottom: 4px;
            font-size: 14px;
        }
        .panel input[type="number"],
        .panel input[type="text"],
        .panel input[type="file"] {
            width: 100%;
            max-width: 320px;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #111;
            color: #eee;
            font-family: Verdana, sans-serif;
            font-size: 14px;
        }
        .btn {
            padding: 12px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-family: Verdana, sans-serif;
            font-size: 14px;
        }
        .btn-primary {
            background: #3d8db7;
            color: white;
        }
        .btn-primary:hover:enabled {
            background: #2a6a8e;
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #preview {
            white-space: pre-wrap;
            background: #000;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            min-height: 150px;
            line-height: 1.5;
            font-size: 14px;
            overflow-y: auto;
            max-height: 300px;
        }
        #status {
            margin-top: 10px;
            font-size: 13px;
            color: #aaa;
        }
        #fileInfo {
            font-size: 13px;
            margin-top: 8px;
            color: #ccc;
        }
    </style>
</head>

<body>
    <h1>Dark PDF Converter</h1>
    <p>TXT / PDF / DOCX → PDF con sfondo nero, testo bianco, font leggibile tipo Verdana, dimensione e interlinea configurabile.</p>

    <!-- Upload -->
    <div class="panel">
        <label for="fileInput">File (TXT, PDF, DOCX):</label>
        <input type="file" id="fileInput" accept=".txt,.pdf,.docx">
        <p id="fileInfo"></p>
    </div>

    <!-- Impostazioni -->
    <div class="panel">
        <label for="fontSize">Font size (px):</label>
        <input type="number" id="fontSize" value="14" min="12" max="30">

        <label for="lineHeight">Interlinea:</label>
        <input type="number" id="lineHeight" value="1.5" min="1" max="3" step="0.1">

        <label for="title">Titolo documento (opzionale):</label>
        <input type="text" id="title" placeholder="Titolo">
    </div>

    <!-- Anteprima -->
    <div class="panel">
        <h3>Anteprima</h3>
        <div id="preview">Carica un file per vedere il contenuto…</div>
    </div>

    <!-- Esporta -->
    <div class="panel">
        <button class="btn btn-primary" id="exportPdf" disabled>Esporta PDF Dark</button>
        <p id="status"></p>
    </div>

<script>
let uploadedText = "";

// CARICAMENTO FILE
document.getElementById("fileInput").addEventListener("change", async e => {
    const file = e.target.files[0];
    if (!file) return;

    const status = document.getElementById("status");
    status.textContent = "Lettura file…";

    try {
        if (file.type === "text/plain") {
            uploadedText = await file.text();
        } else if (file.type === "application/pdf") {
            uploadedText = await extractTextFromPdf(file);
        } else if (file.type ===
            "application/vnd.openxmlformats-officedocument.wordprocessingml.document") {
            uploadedText = await extractTextFromDocx(file);
        } else {
            alert("Tipo file non supportato");
            status.textContent = "Tipo file non supportato.";
            return;
        }

        document.getElementById("fileInfo").textContent = "Caricato: " + file.name;
        document.getElementById("preview").textContent = uploadedText.substring(0, 2000);
        document.getElementById("exportPdf").disabled = false;
        status.textContent = "File pronto.";
    } catch (err) {
        console.error(err);
        status.textContent = "Errore nella lettura del file.";
        alert("Errore lettura file: " + err);
    }
});

// Estrazione testo da PDF
async function extractTextFromPdf(file) {
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
    let text = "";
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(it => it.str).join(" ") + "\n\n";
    }
    return text;
}

// Estrazione testo da DOCX
async function extractTextFromDocx(file) {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer });
    return result.value;
}

// ESPORTAZIONE PDF
document.getElementById("exportPdf").addEventListener("click", exportPdf);
    function exportPdf() {
    const preview = document.getElementById("preview");
    
    // CREA DIV con anteprima ESATTA
    const printDiv = document.createElement('div');
    printDiv.style.cssText = `
        font-family: Verdana, sans-serif !important;
        font-size: ${document.getElementById("fontSize").value}px !important;
        line-height: ${document.getElementById("lineHeight").value} !important;
        background: black !important;
        color: white !important;
        padding: 40px !important;
        width: 595px !important;
        margin: 0 !important;
        position: absolute !important;
        left: -9999px !important;
        top: -9999px !important;
        white-space: pre-wrap !important;
    `;
    printDiv.textContent = preview.textContent;

    document.body.appendChild(printDiv);

    html2pdf().set({
        margin: 10,
        filename: 'PDF-Dark.pdf',
        image: { type: 'png', quality: 0.98 },
        html2canvas: { scale: 2, backgroundColor: '#000000', useCORS: true },
        jsPDF: { orientation: 'portrait', unit: 'mm', format: 'a4' }
    }).from(printDiv).save().then(() => {
        document.body.removeChild(printDiv);
        document.getElementById("status").textContent = "PDF creato!";
    });
}


function drawBackground(page, rgb) {
    const { width, height } = page.getSize();
    page.drawRectangle({
        x: 0,
        y: 0,
        width,
        height,
        color: rgb(0, 0, 0)
    });
}
</script>

</body>
</html>
