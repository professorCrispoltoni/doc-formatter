<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dark PDF Converter</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        body {
            background: #111;
            color: #eee;
            font-family: Verdana, sans-serif;
            padding: 20px;
        }
        h1 { margin-top: 0; }
        .panel {
            background: #1b1b1b;
            border: 1px solid #333;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-top: 10px;
            margin-bottom: 4px;
            font-size: 14px;
        }
        input[type="number"], input[type="text"], input[type="file"] {
            width: 100%;
            max-width: 320px;
            padding: 6px 8px;
            border-radius: 4px;
            border: 1px solid #444;
            background: #111;
            color: #eee;
            font-family: Verdana, sans-serif;
            font-size: 14px;
        }
        .btn {
            padding: 12px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-family: Verdana, sans-serif;
            font-size: 14px;
            background: #3d8db7;
            color: white;
        }
        .btn:hover:not(:disabled) { background: #2a6a8e; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        #preview {
            white-space: pre-wrap;
            background: #000;
            color: #fff;
            padding: 20px;
            border-radius: 8px;
            min-height: 150px;
            line-height: 1.5;
            font-size: 14px;
            overflow-y: auto;
            max-height: 300px;
        }
        #status { margin-top: 10px; font-size: 13px; color: #aaa; }
        #fileInfo { font-size: 13px; margin-top: 8px; color: #ccc; }
    </style>
</head>
<body>
    <h1>Dark PDF Converter</h1>
    <p>Carica TXT/PDF/DOCX â†’ PDF nero con testo bianco</p>

    <div class="panel">
        <label for="fileInput">File (TXT, PDF, DOCX):</label>
        <input type="file" id="fileInput" accept=".txt,.pdf,.docx">
        <p id="fileInfo"></p>
    </div>

    <div class="panel">
        <label for="fontSize">Dimensione font (px):</label>
        <input type="number" id="fontSize" value="16" min="12" max="24">
        <label for="lineHeight">Interlinea:</label>
        <input type="number" id="lineHeight" value="1.8" min="1" max="3" step="0.1">
    </div>

    <div class="panel">
        <h3>Anteprima</h3>
        <div id="preview">Carica un file...</div>
    </div>

    <div class="panel">
        <button class="btn" id="exportPdf" disabled>Esporta PDF Dark</button>
        <p id="status"></p>
    </div>

<script>
let uploadedText = '';

document.getElementById('fileInput').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const status = document.getElementById('status');
    status.textContent = 'Lettura...';

    try {
        if (file.type === 'text/plain') {
            uploadedText = await file.text();
        } else if (file.type === 'application/pdf') {
            uploadedText = await readPdf(file);
        } else if (file.name.endsWith('.docx')) {
            uploadedText = await readDocx(file);
        } else {
            return alert('Formato non supportato');
        }

        document.getElementById('fileInfo').textContent = `Caricato: ${file.name}`;
        document.getElementById('preview').textContent = uploadedText;
        document.getElementById('exportPdf').disabled = false;
        status.textContent = 'Pronto!';
    } catch (err) {
        status.textContent = 'Errore lettura';
        alert('Errore: ' + err.message);
    }
});

async function readPdf(file) {
    const pdfjsLib = await import('https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js');
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    
    const buffer = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument(buffer).promise;
    let text = '';
    
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n\n';
    }
    return text;
}

async function readDocx(file) {
    const mammoth = await import('https://cdn.jsdelivr.net/npm/mammoth@1.5.0/mammoth.browser.min.js');
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.default.extractRawText({ arrayBuffer });
    return result.value;
}

document.getElementById('exportPdf').addEventListener('click', exportPdf);

function exportPdf() {
    if (!uploadedText.trim()) return alert('Nessun testo');

    const fontSize = document.getElementById('fontSize').value;
    const lineHeight = document.getElementById('lineHeight').value;

    const printDiv = document.createElement('div');
    printDiv.style.cssText = `
        font-family: Verdana, sans-serif !important;
        font-size: ${fontSize}px !important;
        line-height: ${lineHeight} !important;
        background: black !important;
        color: white !important;
        padding: 40px !important;
        width: 21cm !important;
        margin: 0 !important;
        white-space: pre-wrap !important;
        word-wrap: break-word !important;
    `;
    printDiv.textContent = uploadedText;

    document.body.appendChild(printDiv);

    html2pdf().set({
        margin: [1, 1, 1, 1],
        filename: 'PDF-Dark.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, backgroundColor: '#000000', useCORS: true },
        jsPDF: { unit: 'cm', format: 'a4', orientation: 'portrait' }
    }).from(printDiv).save().then(() => {
        document.body.removeChild(printDiv);
        document.getElementById('status').textContent = 'PDF creato!';
    });
}
</script>
</body>
</html>
